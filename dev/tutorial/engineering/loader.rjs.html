<h2>avalon自带加载器</h2>
<script>
    avalon.define({
        $id: "include",
        path: "loader.menu.html"
    })
</script>
<div ms-controller="include" ms-include-src="path" data-include-replace="true">

</div>

<p>我们是使用requirejs自带的r.js进行合并的，因为r.js已经足够健壮强大，我们不需要重复造轮子。 不过除了r.js，我们还需要其原来的text.js, css.js等插件,
    这些我已经合并放到avalon仓库下的combo目录下了。</p>
<ul>
    <li><a href="https://github.com/jrburke/r.js/tree/master/dist">r.js</a>, 打包用的主程序</li>
    <li><a href="https://github.com/guybedford/require-css">css.js css-builder.js normalize.js </a>css!资源插件及其打包用程序</li>
    <li><a href="https://github.com/requirejs/text">text.js </a>text!资源插件,它本身就整合打包逻辑</li>
    <li><a href="https://github.com/requirejs/domReady">domReady.js </a>domReady!资源插件,判定是否domReady</li>
</ul>
<p>我们先来一个简单的例子：</p>
<div><img src="../../assets/css/engineering/loader/build0_0.jpg"/></div>
<p>这里有一坨坨文件，其中有一半是从combo目录拷贝过来，此外还有avalon.js，只有index.html, main.js， aaa.js, aaa.html, aaa.css及图片是用户自己的。</p>
<p>index.html</p>
<pre class="brush:html;gutter:false;toolbar:false">
<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script src="avalon.js" id="aaa" data-main="main"></script>
    </head>
    <body>

    </body>
</html>
</xmp>
<p>aaa.html，它是一个模板文件，不是一个子页面。当然你也可以改名为aaa.txt, aaa.string，反正都是用AJAX加载的。</p>
<xmp class="html">
<div id="news">
    <div class="Q-tpList">
        <a target="_blank" class="pic" href="/a/20150209/003871.htm">
            <img class="picto" src="116337024.jpg"></a>
        <em class="f14 l24"><a target="_blank" class="linkto" href="/a/20150209/003871.htm">南昌一小学仅2名老师8名学生 靠杂草生火取暖</a></em>
        <p class="l22">招贤镇牛岭小学距湾里城区22公里，是湾里区最偏远、落后的小学之一，
            现在拥有8个学生，2个老师。学生居住分散，上学路途遥远，
            离校最远的学生要走上2个多小时的山路。</p>
    </div>
</div>
</xmp>
<p>aaa.css，这个也是用avalon.js的加载器动态引入的。</p>
<pre class="brush:css;gutter:false;toolbar:false">
#news .Q-tpList {
    border: 1px solid #f0f0f0;
    position: relative;
    width:800px;
    padding-bottom: 14px;
}
#news a{
    color:black;
    text-decoration: none;
}
#news .Q-tpList .pic {
    margin: 13px 19px 0 0;
    width: 120px;
    height: 80px;
    position: relative;
}
#news .Q-tpList em {
    font: 20px/35px "微软雅黑","simhei";
    margin: 8px 0 0;
    display: inline-block;
}
</xmp>
<p>aaa.js是我们JS模块，是用来写业务逻辑。作为一个例子，就随便写点东西吧。所有业务模块都应该用define函数进行定义与组织。</p>
<xmp class="javascript">
define(function() {
    return function(text) {
        var div =  document.createElement("div")
        div.innerHTML = text
        return div
    }
})
</xmp>
<p>main.js是入口文件，学过C的都知道，main代表当前程序的最先执行的函数。在这里我们可以用require.config进行各种配置，
    并用require函数牵动整个程序运行。</p>
<xmp class="javascript">
require.config({
    baseUrl: "."
})

require(["aaa", "text!aaa.html", "css!aaa", "domReady!"], function(a, b) {
    document.body.appendChild(a(b))
})
</xmp>
<p>启动服务器,打开index.html,我们就会发现可以运行了!!</p>
<div><img src="zh/engineering/loader/build0_1.jpg"/></div>
<p>好了,我们看一下如何打包.在当前目录下建一个build.js。里面的内容有点类似JSON, 需要两边用小括号括起来，里面还可以写注释。</p>
<xmp class="javascript">
({
    name: "main",
    out: "main-built.js"
})
</xmp>
<div><img src="zh/engineering/loader/build0_2.jpg"/></div>
<p>然后改一下index.html中的script标签的data-main的属性值，main改成main-built，运行： </p>
<div><img src="zh/engineering/loader/build0_3.png"/></div>
<p>可以点<a href="zh/engineering/loader/build0.rar" download="build0.rar">这里</a>下载此例子</p>
<br>
<p><b>例子2</b></p>
<p>上面的例子就是一个玩具。通常我们是不会把所有东西放在一个目录下，我们将上面的例子稍加改造。
我们分两个文件放置我们的代码， combo目录是放合并用到的JS模块及一些基础库(avalon.js)，
    另一个modules是放置业务代码, 按模块划分, 目前只有aaa模块,里面是它用到JS,模板,样式与图片。
</p>
<div><img src="zh/engineering/loader/build1_0.jpg"/></div>
<p>index.html改成这样</p>
<pre class="brush:html;gutter:false;toolbar:false">
<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <script src="combo/avalon.js" id="aaa" data-main="modules/aaa/main"></script>
    </head>
    <body>

    </body>
</html>
</xmp>
<p>main.js的内容:</p>
<xmp class="javascript">
require.config({
    baseUrl: "modules/aaa",
    paths: {
        text: "../../combo/text",
        css: "../../combo/css",
        domReady: "../../combo/domReady"
    }
})

require(["aaa", "text!aaa.html", "css!aaa", "domReady!"], function(a, b) {
    document.body.appendChild(a(b))
})
</xmp>
<p>aaa.html的内容也要改一下图片路径:</p>
<xmp class="html">
<div id="news">
    <div class="Q-tpList">
        <a target="_blank" class="pic" href="/a/20150209/003871.htm">
            <img class="picto" src="modules/aaa/116337024.jpg"></a>
        <em class="f14 l24"><a target="_blank" class="linkto" href="/a/20150209/003871.htm">南昌一小学仅2名老师8名学生 靠杂草生火取暖</a></em>
        <p class="l22">招贤镇牛岭小学距湾里城区22公里，是湾里区最偏远、落后的小学之一，
            现在拥有8个学生，2个老师。学生居住分散，上学路途遥远，
            离校最远的学生要走上2个多小时的山路。</p>
    </div>
</div>
</xmp>

<p>运行如下:</p>
<div><img src="zh/engineering/loader/build1_1.jpg"/></div>
<p>好了，我们看一下如何合并吧。在combo目录下建立一个build.js。</p>

<xmp class="javascript">
({
    baseUrl: "../modules/aaa",//找到main.js文件的目录
    paths: {
        text: "../../combo/text", //由于分居两个目录，因此路径都需要处理一下
        css: "../../combo/css",
        "css-builder": "../../combo/css-builder",
        "normalize": "../../combo/normalize",
        domReady: "../../combo/domReady"
    },
    name: "main",  //如果从哪一个文件开始合并
    out: "../modules/aaa/main-built.js" //确定要生成的文件路径及名字
})
</xmp>
<p>接着执行命令，然后将data-main的属性改一下， <b>modules/aaa/main</b> --< <b>modules/aaa/main-built</b></p>
<div><img src="zh/engineering/loader/build1_3.jpg"/></div>
<p>可以点<a href="zh/engineering/loader/build1.rar" download="build1.rar">这里</a>下载此例子</p>
<br>
<p><strong>例3</strong></p>
<p>通常把我们自己工作的环境叫做发展环境， 上线的环境叫生产坏境，将它们分开是非常有好处的。看下面目录</p>
<div><img src="zh/engineering/loader/build2_0.png"/></div>
<xmp class="html">
<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>My App</title>
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <script data-main="develop/main" src="develop/avalon.js"></script>
    </head>
    <body>
        <h1>My App</h1>
    </body>
</html>
</xmp>
<p>one.js</p>
<xmp class="javascript">
define(["two"], function(a){
    return "<h2>合并示例</h2>" + a
})
</xmp>
<p>two.js</p>
<xmp class="javascript">
define(function(){
    return "<p>built by avalon.js  + r.js</p>"
})
</xmp>

<p>sub/three.js</p>
<xmp class="javascript">
define(function(){
    return "<p>另外一行</p>"
})
</xmp>
<p>main.js</p>
<xmp class="javascript">
require.config({
    paths: {
        jquery: "jquery/jquery-1.11.2"
    }
})
require(["one", "sub/three","jquery"], function(one, three, $) {
    $("body").append(one+three)
});
</xmp>
<div><img src="zh/engineering/loader/build2_1.jpg"/></div>
<p>我们再看如何编写构建脚本, build.js如下, 用了一个dir配置项:</p>
<xmp class="javascript">
({
    baseUrl: ".",
    paths: {
        jquery: "jquery/jquery-1.11.2"
    },
    dir: "../production",
    name: "main"
})
</xmp>
<div><img src="zh/engineering/loader/build2_2.jpg"/></div>
<p>发现production目录生成出来了， 里面的文件好像一模一样，但其中main.js体积增大不少，已经将其依赖全部合并进去。上线时使用production目录，我们有两个办法，
    1自己修改或通过脚本修改index.html引用脚本的路径，2后端配置一下，对请求进行重定向，我们通常是使用后面一种。</p>
<div><img src="zh/engineering/loader/build2_3.jpg"/></div>
<p>可以点<a href="zh/engineering/loader/build2.rar" download="build2.rar">这里</a>下载此例子</p>
<p><a href="http://tech.pro/blog/1639/using-rjs-to-optimize-your-requirejs-project">http://tech.pro/blog/1639/using-rjs-to-optimize-your-requirejs-project</a></p>
